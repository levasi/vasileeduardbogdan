import{ac as B,_ as M,a2 as C,a5 as _,aC as P,a7 as T,am as V,aD as v,L as j,ad as I,aE as N,G as W,k as F,C as k,aF as q,T as X,aG as Y}from"./DxyHs_SD.js";import"./CDs0j8a9.js";const Z=Array(1024).fill(0).map((m,e)=>Math.pow(e/255*.9478672986+.0521327014,2.4));class tt extends B{constructor(e){super(e),this.type=M}setDataType(e){return this.type=e,this}parse(e,i){const g={version:null,baseRenditionIsHDR:null,gainMapMin:null,gainMapMax:null,gamma:null,offsetSDR:null,offsetHDR:null,hdrCapacityMin:null,hdrCapacityMax:null},l=new TextDecoder,n=new DataView(e);let a=0;const t=[];for(;a<n.byteLength;){const r=n.getUint8(a);if(r===255){const s=n.getUint8(a+1);[216,224,225,226].includes(s)?(t.push({sectionType:s,section:[r,s],sectionOffset:a+2}),a+=2):(t[t.length-1].section.push(r,s),a+=2)}else t[t.length-1].section.push(r),a++}let o,p;for(let r=0;r<t.length;r++){const{sectionType:s,section:c,sectionOffset:w}=t[r];if(s!==224){if(s===225)this._parseXMPMetadata(l.decode(new Uint8Array(c)),g);else if(s===226){const h=new DataView(new Uint8Array(c.slice(2)).buffer);if(h.getUint32(2,!1)===1297106432){const f=h.getUint32(6)===1229531648,u=60,D=h.getUint32(u,f),U=h.getUint32(u+4,f),d=h.getUint32(u+16,f),H=h.getUint32(u+20,f)+w+6;o=new Uint8Array(n.buffer,U,D),p=new Uint8Array(n.buffer,H,d)}}}}if(!g.version)throw new Error("THREE.UltraHDRLoader: Not a valid UltraHDR image");if(o&&p)this._applyGainmapToSDR(g,o,p,(r,s,c)=>{i({width:s,height:c,data:r,format:C,type:this.type})},r=>{throw new Error(r)});else throw new Error("THREE.UltraHDRLoader: Could not parse UltraHDR images")}load(e,i,g,l){const n=new _(this.type===M?new Uint16Array:new Float32Array,0,0,C,this.type,P,T,T,V,v,1,j);n.generateMipmaps=!0,n.flipY=!0;const a=new I(this.manager);return a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setPath(this.path),a.setWithCredentials(this.withCredentials),a.load(e,t=>{try{this.parse(t,o=>{n.image={data:o.data,width:o.width,height:o.height},n.needsUpdate=!0,i&&i(n,o)})}catch(o){l&&l(o),console.error(o)}},g,l),n}_parseXMPMetadata(e,i){const l=new DOMParser().parseFromString(e.substring(e.indexOf("<"),e.lastIndexOf(">")+1),"text/xml"),[n]=l.getElementsByTagName("Container:Directory");if(!n){const[a]=l.getElementsByTagName("rdf:Description");i.version=a.getAttribute("hdrgm:Version"),i.baseRenditionIsHDR=a.getAttribute("hdrgm:BaseRenditionIsHDR")==="True",i.gainMapMin=parseFloat(a.getAttribute("hdrgm:GainMapMin")||0),i.gainMapMax=parseFloat(a.getAttribute("hdrgm:GainMapMax")||1),i.gamma=parseFloat(a.getAttribute("hdrgm:Gamma")||1),i.offsetSDR=parseFloat(a.getAttribute("hdrgm:OffsetSDR")/(1/64)),i.offsetHDR=parseFloat(a.getAttribute("hdrgm:OffsetHDR")/(1/64)),i.hdrCapacityMin=parseFloat(a.getAttribute("hdrgm:HDRCapacityMin")||0),i.hdrCapacityMax=parseFloat(a.getAttribute("hdrgm:HDRCapacityMax")||1)}}_srgbToLinear(e){return e/255<.04045?e/255*.0773993808:e<1024?Z[~~e]:Math.pow(e/255*.9478672986+.0521327014,2.4)}_applyGainmapToSDR(e,i,g,l,n){const a=t=>new Promise((o,p)=>{const r=document.createElement("img");r.onload=()=>{const s={width:r.naturalWidth,height:r.naturalHeight,source:r};URL.revokeObjectURL(r.src),o(s)},r.onerror=()=>{URL.revokeObjectURL(r.src),p()},r.src=URL.createObjectURL(new Blob([t],{type:"image/jpeg"}))});Promise.all([a(i),a(g)]).then(([t,o])=>{const p=t.width/t.height,r=o.width/o.height;if(p!==r){n("THREE.UltraHDRLoader Error: Aspect ratio mismatch between SDR and Gainmap images");return}const s=document.createElement("canvas"),c=s.getContext("2d",{willReadFrequently:!0,colorSpace:"srgb"});s.width=t.width,s.height=t.height,c.drawImage(o.source,0,0,o.width,o.height,0,0,t.width,t.height);const w=c.getImageData(0,0,t.width,t.height,{colorSpace:"srgb"});c.drawImage(t.source,0,0);const h=c.getImageData(0,0,t.width,t.height,{colorSpace:"srgb"});let y;this.type===M?y=new Uint16Array(h.data.length).fill(23544):y=new Float32Array(h.data.length).fill(255);const f=Math.sqrt(Math.pow(1.8,e.hdrCapacityMax)),u=(Math.log2(f)-e.hdrCapacityMin)/(e.hdrCapacityMax-e.hdrCapacityMin),D=Math.min(Math.max(u,0),1),U=e.gamma===1;for(let d=0;d<h.data.length;d+=4){const H=d/4%t.width,E=Math.floor(d/4/t.width);for(let R=0;R<3;R++){const S=h.data[d+R],O=(E*t.width+H)*4+R,b=w.data[O]/255,L=U?b:Math.pow(b,1/e.gamma),A=e.gainMapMin*(1-L)+e.gainMapMax*L,G=(S+e.offsetSDR)*(A*D===0?1:Math.pow(2,A*D))-e.offsetHDR,x=Math.min(Math.max(this._srgbToLinear(G),0),65504);y[d+R]=this.type===M?N.toHalfFloat(x):x}}l(y,t.width,t.height)}).catch(()=>{throw new Error("THREE.UltraHDRLoader Error: Could not parse UltraHDR images")})}}const et=""+new URL("san_giuseppe_bridge_2k.DZwWv-1U.jpg",import.meta.url).href,z=""+new URL("rad-grad.Bwfu9Sul.png",import.meta.url).href,J=new X;function K({hasFog:m,color:e,opacity:i,path:g,pos:l,size:n}){const a=new q({color:e,fog:m,map:J.load(g),transparent:!0,opacity:i});a.color.offsetHSL(0,0,Math.random()*.2-.1);const t=new Y(a);return t.position.set(l.x,-l.y,l.z),n+=Math.random()-.5,t.scale.set(n,n,n),t.material.rotation=0,t}function at({hasFog:m=!0,hue:e=0,numSprites:i=10,opacity:g=1,path:l=z,radius:n=1,sat:a=.5,size:t=1,z:o=0}={}){const p=new W;for(let r=0;r<i;r+=1){let s=r/i*Math.PI*2;const c=new F(Math.cos(s)*Math.random()*n,Math.sin(s)*Math.random()*n,o+Math.random());new F(c.x,c.y,0).length();let w=new k().setHSL(e,1,a);const h=K({hasFog:m,color:w,opacity:g,path:l,pos:c,size:t});p.add(h)}return p}export{tt as U,et as a,at as g};
