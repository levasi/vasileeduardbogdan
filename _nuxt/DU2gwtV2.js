import{ae as B,a0 as R,a4 as F,a7 as _,aO as G,a9 as T,ao as P,aP as V,L as v,af as j,aQ as N}from"./C__p7v9B.js";import"./D2BRVPHh.js";const W=Array(1024).fill(0).map((x,t)=>Math.pow(t/255*.9478672986+.0521327014,2.4));class k extends B{constructor(t){super(t),this.type=R}setDataType(t){return this.type=t,this}parse(t,n){const g={version:null,baseRenditionIsHDR:null,gainMapMin:null,gainMapMax:null,gamma:null,offsetSDR:null,offsetHDR:null,hdrCapacityMin:null,hdrCapacityMax:null},c=new TextDecoder,s=new DataView(t);let a=0;const e=[];for(;a<s.byteLength;){const r=s.getUint8(a);if(r===255){const o=s.getUint8(a+1);[216,224,225,226].includes(o)?(e.push({sectionType:o,section:[r,o],sectionOffset:a+2}),a+=2):(e[e.length-1].section.push(r,o),a+=2)}else e[e.length-1].section.push(r),a++}let i,f;for(let r=0;r<e.length;r++){const{sectionType:o,section:h,sectionOffset:D}=e[r];if(o!==224){if(o===225)this._parseXMPMetadata(c.decode(new Uint8Array(h)),g);else if(o===226){const l=new DataView(new Uint8Array(h.slice(2)).buffer);if(l.getUint32(2,!1)===1297106432){const d=l.getUint32(6)===1229531648,u=60,y=l.getUint32(u,d),U=l.getUint32(u+4,d),p=l.getUint32(u+16,d),H=l.getUint32(u+20,d)+D+6;i=new Uint8Array(s.buffer,U,y),f=new Uint8Array(s.buffer,H,p)}}}}if(!g.version)throw new Error("THREE.UltraHDRLoader: Not a valid UltraHDR image");if(i&&f)this._applyGainmapToSDR(g,i,f,(r,o,h)=>{n({width:o,height:h,data:r,format:F,type:this.type})},r=>{throw new Error(r)});else throw new Error("THREE.UltraHDRLoader: Could not parse UltraHDR images")}load(t,n,g,c){const s=new _(this.type===R?new Uint16Array:new Float32Array,0,0,F,this.type,G,T,T,P,V,1,v);s.generateMipmaps=!0,s.flipY=!0;const a=new j(this.manager);return a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setPath(this.path),a.setWithCredentials(this.withCredentials),a.load(t,e=>{try{this.parse(e,i=>{s.image={data:i.data,width:i.width,height:i.height},s.needsUpdate=!0,n&&n(s,i)})}catch(i){c&&c(i),console.error(i)}},g,c),s}_parseXMPMetadata(t,n){const c=new DOMParser().parseFromString(t.substring(t.indexOf("<"),t.lastIndexOf(">")+1),"text/xml"),[s]=c.getElementsByTagName("Container:Directory");if(!s){const[a]=c.getElementsByTagName("rdf:Description");n.version=a.getAttribute("hdrgm:Version"),n.baseRenditionIsHDR=a.getAttribute("hdrgm:BaseRenditionIsHDR")==="True",n.gainMapMin=parseFloat(a.getAttribute("hdrgm:GainMapMin")||0),n.gainMapMax=parseFloat(a.getAttribute("hdrgm:GainMapMax")||1),n.gamma=parseFloat(a.getAttribute("hdrgm:Gamma")||1),n.offsetSDR=parseFloat(a.getAttribute("hdrgm:OffsetSDR")/(1/64)),n.offsetHDR=parseFloat(a.getAttribute("hdrgm:OffsetHDR")/(1/64)),n.hdrCapacityMin=parseFloat(a.getAttribute("hdrgm:HDRCapacityMin")||0),n.hdrCapacityMax=parseFloat(a.getAttribute("hdrgm:HDRCapacityMax")||1)}}_srgbToLinear(t){return t/255<.04045?t/255*.0773993808:t<1024?W[~~t]:Math.pow(t/255*.9478672986+.0521327014,2.4)}_applyGainmapToSDR(t,n,g,c,s){const a=e=>new Promise((i,f)=>{const r=document.createElement("img");r.onload=()=>{const o={width:r.naturalWidth,height:r.naturalHeight,source:r};URL.revokeObjectURL(r.src),i(o)},r.onerror=()=>{URL.revokeObjectURL(r.src),f()},r.src=URL.createObjectURL(new Blob([e],{type:"image/jpeg"}))});Promise.all([a(n),a(g)]).then(([e,i])=>{const f=e.width/e.height,r=i.width/i.height;if(f!==r){s("THREE.UltraHDRLoader Error: Aspect ratio mismatch between SDR and Gainmap images");return}const o=document.createElement("canvas"),h=o.getContext("2d",{willReadFrequently:!0,colorSpace:"srgb"});o.width=e.width,o.height=e.height,h.drawImage(i.source,0,0,i.width,i.height,0,0,e.width,e.height);const D=h.getImageData(0,0,e.width,e.height,{colorSpace:"srgb"});h.drawImage(e.source,0,0);const l=h.getImageData(0,0,e.width,e.height,{colorSpace:"srgb"});let m;this.type===R?m=new Uint16Array(l.data.length).fill(23544):m=new Float32Array(l.data.length).fill(255);const d=Math.sqrt(Math.pow(1.8,t.hdrCapacityMax)),u=(Math.log2(d)-t.hdrCapacityMin)/(t.hdrCapacityMax-t.hdrCapacityMin),y=Math.min(Math.max(u,0),1),U=t.gamma===1;for(let p=0;p<l.data.length;p+=4){const H=p/4%e.width,C=Math.floor(p/4/e.width);for(let w=0;w<3;w++){const E=l.data[p+w],O=(C*e.width+H)*4+w,M=D.data[O]/255,b=U?M:Math.pow(M,1/t.gamma),L=t.gainMapMin*(1-b)+t.gainMapMax*b,S=(E+t.offsetSDR)*(L*y===0?1:Math.pow(2,L*y))-t.offsetHDR,A=Math.min(Math.max(this._srgbToLinear(S),0),65504);m[p+w]=this.type===R?N.toHalfFloat(A):A}}c(m,e.width,e.height)}).catch(()=>{throw new Error("THREE.UltraHDRLoader Error: Could not parse UltraHDR images")})}}const X=""+new URL("san_giuseppe_bridge_2k.DZwWv-1U.jpg",import.meta.url).href;export{k as U,X as g};
